Title: Lab 11 â€“ Mining the social web
Author: Dr. Glasbrenner
Author_Image: https://www.gravatar.com/avatar/49802fdfa5a0e63b3d932a5179d41c1e
Date: 2019-01-01 00:00
Tags: lab
Slug: lab-11-mining-the-social-web
Summary: Accessing the Twitter API using <span style="monospace">rtweet</span> and exploring what you can do with the harvested data
Show_summary: true
Show_link: true

```{r setup, include = FALSE}
suppressPackageStartupMessages(library(tidyverse))

icon_pdf <- '<i class="fas fa-file-pdf" data-fa-transform="grow-16"></i>&nbsp;'
icon_github <- '<i class="fab fa-github-alt" data-fa-transform="grow-16"></i>&nbsp;'
lab_name <- "Lab 11"
icon_pdf <- '<i class="fas fa-file-pdf" data-fa-transform="grow-2"></i>&nbsp;'
icon_link <- '<i class="fas fa-link"></i>'
icon_github <- '<i class="fab fa-github-alt" data-fa-transform="grow-16"></i>&nbsp;'
icon_link_bullet <- '<i class="fas fa-link" data-fa-transform="grow-2"></i>&nbsp;'
lab_name <- "Lab 11"
starter_file <- "lab11.Rmd"
```

## Instructions

Obtain the GitHub repository you will use to complete the lab, which contains a starter file named [`r starter_file`]{.monospace}.
This lab shows you how to access the Twitter API using the [rtweet]{.monospace} package and how to analyze the harvested data.
Carefully read the lab instructions and complete the exercises using the provided spaces within your starter file [`r starter_file`]{.monospace}.
Then, when you're ready to submit, follow the directions in the [`r icon_link`How to submit](#how-to-submit) section below.

## Gathering data using an API

Most of the datasets you've worked with during this course were stored in files that were easy to load using R.
While this is convenient, it isn't always the case that a dataset will already have been gathered for you and you will need to collect the data yourself.
For example, if you want to investigate current and ongoing trends taking place on the internet, you will need to find a way to extract relevant data from one or more websites.
The general practice of gathering data from a website is called _web scraping_ and the amount of effort needed to scrape any given webpage depends on many factors.
That's why it's always worth your while to check and see if a website has an **application programming interface**, also known as an **API**, which provides a convenient and structured way to access and interact with website data.
[`r icon_link`Twitter][twitter-url] is an example of website with an API that is used by app developers and data scientists alike.
The recommended way to access the Twitter API from R is by using the [tidyverse]{.monospace}-compatible package called [`r icon_link`[rtweet]{.monospace}][r-rtweet-github], which we will learn how to use during this lab.

## [rtweet]{.monospace} setup instructions

To access data from the Twitter API for this lab, you will need to configure your RStudio environment so that Twitter recognizes you as an authenticated user.
There are two ways to configure [rtweet]{.monospace} so that it works on RStudio Server, both of which are detailed below.

### Method 1: Create an App on developer.twitter.com

::: {.callout .secondary}
[Important!]{.h4}

This is the recommended method for accessing the Twitter API from RStudio Server.
However, it will only work if you have a valid Twitter account and the course instructor has been able to invite you to join the CDS 102 developer team.
Unfortunately, [`r icon_link`there is a known issue where team invites fail for some users][twitter-team-invite-issues] and there is no timeline for when this problem will be fixed.
If the instructor is unable to send you an team invitation, try following the instructions in [`r icon_link`Method 2](#method-2-generate-a-token-using-your-local-computer).
:::

This method will have you generate an authentication token by creating a Twitter App on [developer.twitter.com][twitter-developer-site].
Don't worry, you're not actually developing an application, this just happens to be the easiest way to get one of these tokens.
Navigate to <https://developer.twitter.com/en/apps>, login to your Twitter account, and click the **Create New App**.

```{r twitter-developer-create-app, echo = FALSE, fig.align = "center"}
knitr::include_graphics("img/twitter_developer_create_app.png")
```

This will open a page where you will enter the necessary information for creating a new app.
Fill in the form using the information provided below.
If a form field is not listed, then that means you should leave it blank.

::: {.callout .secondary}
[Important!]{.h4}

In the **App name** field, replace [\<extra\>]{.monospace} with a sequence of letters or numbers of your choosing.
:::

*   **App name:** [cds-102-lab-\<extra\>]{.monospace}

*   **Application description:** [For completing a CDS 102 lab.]{.monospace}

*   **Website URL:** [https<!-- breaklink -->://www.cds101.com]{.monospace}

*   **Callback URLs:** [http<!-- breaklink -->://127.0.0.1:1410]{.monospace}

*   **Tell us how this app will be used:** [This application is solely for educational purposes so that I can access the Twitter API as part of the CDS 102 course offered at George Mason University. I will be using the Twitter API to complete the following lab: https<!-- breaklink -->://www.cds101.com/labs/lab-11-mining-the-social-web/.]{.monospace}

After filling in all the above information, the form will look as follows,

```{r twitter-developer-app-details, echo = FALSE, fig.align = "center"}
knitr::include_graphics("img/twitter_developer_app_details.png")
```

To create the Twitter App, click the **Create** button.

After creating the app, click the tab labeled **Keys and tokens** to retrieve your _consumer API keys_ and _access tokens_.
The page will look something like this,

```{r twitter-developer-keys-and-tokens, echo = FALSE, fig.align = "center"}
knitr::include_graphics("img/twitter_developer_keys_and_tokens.png")
```

::: {.callout .secondary}
[Important!]{.h4}

**Your consumer API keys and access tokens should never be shared with another person or commited to a GitHub repository.**
:::

Leave the **Keys and tokens** page open in a browser tab for the time being and switch over to [`r icon_link`RStudio Server][gmu-rstudio-server].
Activate the project for this lab, then in the _Console_ pane run the following to start the [rtweet]{.monospace} configuration script,

```r
source("configure_rtweet.R")
configure_rtweet_rstudio_server()
```

You will be prompted to enter the following information,

```markdown
Enter your twitter app name:
Enter your twitter consumer api key:
Enter your twitter consumer api secret key:
Enter your twitter access token:
Enter your twitter access token secret:
```
    
The _twitter app name_ should exactly match the _app name_ you entered in the application creation form.
The rest of the information can be copied and pasted directly from the **Keys and tokens** page you have open in your other browser tab.
When you have entered all the information, you will be asked to confirm that what you entered is correct.
If it is, type <kbd>y</kbd> and press <kbd>Enter</kbd> and the script will take care of the rest for you.
Proceed to the section titled [`r icon_link`fetching data about users, their followers, and friends](#fetching-data-about-users-their-followers-and-friends).

### Method 2: Generate a token using your local computer

::: {.callout .secondary}
[Important!]{.h4}

This method should only be used if you are unable to complete [`r icon_link`Method 1](#method-1-create-an-app-on-developer.twitter.com).
:::

This method requires that you have R and RStudio installed on your local computer, for a list of what applications you need to install consult your course syllabus.
Once you have everything installed, launch RStudio and run the following in the _Console_ pane to install the R packages you will need,

```r
install.packages(c("remotes", "fs", "readr", "dplyr", "usethis", "httpuv", "rtweet"))
```



## Fetching data about users, their followers, and friends

There are many things we can analyze using a social media platform.
Like most things, we will start small by stepping through a basic analysis of a single Twitter account.
Our example account will be [[\@CSS\_GMU]{.monospace}][css-gmu-twitter-account], which is the official Twitter account of the Computational Social Science program in George Mason's Computational & Data Sciences Department.

We begin by fetching the basic account information for [[\@CSS\_GMU]{.monospace}][css-gmu-twitter-account], which we will then save to disk for offline access, and then explore the variables returned to us.
To ask the Twitter API for the account information belonging to the Computational Social Science program, we use:

```r
lookup_users("CSS_GMU") %>%
  write_rds(path = path("user_css_gmu", ext = "rds"))
```

This will write a file named [user\_css\_gmu.rds]{.monospace} into your project directory that contains the information we just collected.
To read it into R's memory, we run:

```r
user_css_gmu <- read_rds("user_css_gmu.rds")
```

Now let's take a look at the information we just gathered about [[\@CSS\_GMU]{.monospace}][css-gmu-twitter-account].
Perhaps we can learn something about the account just by looking at the different variables.
Run the following to get a full list of the variables you can look at that are related to the account:

```r
user_css_gmu %>%
  users_data() %>%
  names()
```
    
@.
    Let's focus on the following variables associated with the [[\@CSS\_GMU]{.monospace}][css-gmu-twitter-account] account:
    
    ```r
    user_css_gmu %>%
      users_data() %>%
      select(
        account_created_at,
        description,
        favourites_count,
        followers_count,
        friends_count,
        account_lang
      ) %>%
      glimpse(width = 200)
    ```
    
    What do these variables describe and why might they be interesting to know?
    What other variables do you see after running the `names()` function that would be of interest to a data scientist?

On social media platforms such as Twitter, we can learn a lot about an individual user by looking at the people that user follows (we'll call these *friends*) as well as the people that follow the user (we'll call these *followers*), and by studying the attributes and behaviors that emerge when these users interact with one another.
Thus, while knowing an account's personal attributes can be very useful, we can infer additional information about a user by analyzing the account's friends and followers.
Let's see how this works in practice.

@.
    We need to fetch the friends and followers of the [[\@CSS\_GMU]{.monospace}][css-gmu-twitter-account] account using the `get_followers()` and `get_friends()` functions from [rtweet]{.monospace} as follows:
    
    ```r
    get_followers("CSS_GMU") %>%
      pull(user_id) %>%
      lookup_users() %>%
      write_rds(path = path("css_gmu_followers", ext = "rds"))
    
    get_friends("CSS_GMU") %>%
      pull(user_id) %>%
      lookup_users() %>%
      write_rds(path = path("css_gmu_friends", ext = "rds"))
    ```
    
    Like before, we've saved the data we collected to disk so that we have an offline copy.

    Do you understand what the above code is actually doing?
    Figure out what `get_followers()` and `get_friends()` are doing specifically, and what the `lookup_users()` function is doing in the above code, and explain it.
    Then, write the code that you need to read the [rds]{.monospace} files into R so that you can work with the data.
    Assign the followers data to the variable [css\_gmu\_followers]{.monospace} and the friends data to the variable [css\_gmu\_friends]{.monospace}.

## Visualizing Twitter data

One of the conveniences of the [rtweet]{.monospace} package is that it stores Twitter data in the [tibble]{.monospace} data frame format, so all of the [tidyverse]{.monospace} tools we've learned to use so far can be used for analysis.
Let's work through a few examples of what you can do to analyze this data.

One of the questions we can ask of our data is if there is a relationship between how often [[\@CSS\_GMU]{.monospace}][css-gmu-twitter-account]'s followers tweet and the number of followers they have.
While we're at it, we can also ask: what language do they write their tweets in?

@.
    Use the following command to get an answer to these questions:
    
    ```r
    css_gmu_followers %>%
      users_data() %>%
      ggplot() +
      geom_point(
        mapping = aes(
          x = statuses_count,
          y = followers_count,
          color = account_lang
        )
      ) +
      scale_x_log10() +
      scale_y_log10() +
      coord_equal()
    ```
    
    Notice that we have set our plot to have a log-scale on both axes.
    Why would we want to do that?
    Also, what does this graph tell us about the accounts that follow [[\@CSS\_GMU]{.monospace}][css-gmu-twitter-account], and by consequence, what does all this say about [[\@CSS\_GMU]{.monospace}][css-gmu-twitter-account]?

The ages of the accounts for [[\@CSS\_GMU]{.monospace}][css-gmu-twitter-account]'s friends and followers could contain meaningful patterns and be of interest to us.
For example, it may be that the patterns in the account ages for [[\@CSS\_GMU]{.monospace}][css-gmu-twitter-account] look different from accounts not associated with a University.
    
@.
    Use the following command to create a visualization that looks at the account creation date for followers of [[\@CSS\_GMU]{.monospace}][css-gmu-twitter-account]:

    ```r
    css_gmu_followers %>%
      users_data() %>%
      ggplot() +
      geom_histogram(
        mapping = aes(x = account_created_at),
        bins = 20
      )
    ```

    Describe the distribution of ages of the accounts that follow [[\@CSS\_GMU]{.monospace}][css-gmu-twitter-account], and what can we infer about the account [[\@CSS\_GMU]{.monospace}][css-gmu-twitter-account] itself?

Of course, it wouldn't make sense for us to interact with the Twitter API if we don't grab some actual tweets!
To request tweets for a specific account, we use the `get_timeline()` function.
For example, to request all the tweets by the [[\@CSS\_GMU]{.monospace}][css-gmu-twitter-account] account we use the following command:

```r
get_timeline(user = "CSS_GMU", n = 500) %>%
  write_rds(path = path("css_gmu_all_tweets", ext = "rds"))
```
    
As usual, we save the tweets to disk so that we have an offline copy.
After saving them, we load the tweets and assign them to the variable [css\_gmu\_tweets]{.monospace}:

```r
css_gmu_tweets <- read_rds("css_gmu_all_tweets.rds")
```
    
@.
    Create a timeline plot of [[\@CSS\_GMU]{.monospace}][css-gmu-twitter-account]'s monthly tweeting frequency since the account was first created using the following code:

    ```r
    css_gmu_tweets %>%
      tweets_data() %>%
      ts_plot(by = "months") +
      theme(plot.title = element_text(face = "bold")) +
      labs(
        x = NULL,
        y = NULL,
        title = "Frequency of @CSS_GMU Twitter statuses since account creation",
        subtitle = "Twitter status (tweet) counts aggregated using one-month intervals",
        caption = "\nSource: Data collected from Twitter's REST API via rtweet"
      )
    ```
    
    You'll notice that there's a cyclical pattern to the tweet frequency for this account.
    Explain why this might be happening by suggesting a reasonable hypothesis for the mechanism behind this cyclic behavior.
    
## Choose your own adventure

Now it's your turn to tell a story.
Pick a Twitter account, any account, and explore it using the tools that were just introduced to you.
Your exploratory analysis should be encapsulated in no less than 4 -- 6 separate plots, which you will then interpret and weave into a coherent narrative about your chosen account.
This is an open-ended lab report, so go ahead and have some fun with it!

:::{.callout .primary}
**The grading will be heavily weighted towards this section and what you submit for this part of the lab.**
:::

:::{.callout .secondary}
*   While your story should start with one Twitter account, you are welcome to branch outward by looking at the attributes of the account's friends and followers to enrich and extend your analysis.

*   You are welcome to use any of the available functions in [rtweet]{.monospace}, even if they weren't shown in the exercises.
:::

## How to submit

To submit your lab, follow the two steps below.
Your lab will be graded for credit **after** you've completed both steps!

1.  Save, commit, and push your completed R Markdown file so that everything is synchronized to GitHub.
    If you do this right, then you will be able to view your completed file on the GitHub website.

2.  Knit your R Markdown document to the PDF format, export (download) the PDF file from RStudio Server, and then upload it to *`r lab_name`* posting on Blackboard.

## Cheatsheets

You are encouraged to review and keep the following cheatsheets handy while working on this lab:

*   [data import/tidyr cheatsheet][data-import-cheatsheet]

*   [dplyr cheatsheet][dplyr-cheatsheet]

*   [ggplot2 cheatsheet][ggplot2-cheatsheet]

*   [RStudio cheatsheet][rstudio-cheatsheet]

*   [R Markdown cheatsheet][rmarkdown-cheatsheet]

*   [R Markdown reference][rmarkdown-reference]

## Credits

This lab is licensed under a [Creative Commons Attribution-ShareAlike 4.0 International License][cc-by-sa-4].
Lab instructions and exercises originally created by Joe Shaheen for CDS-102.
Updates to exercises and instructions for compatibility with the [[rtweet]{.monospace}][r-rtweet-github] package by James Glasbrenner.
Figures in the [Creating an App on the Twitter API](#creating-an-app-on-the-twitter-api) section are from the [*Obtaining and using access tokens*](#rtweet-obtaining-access-tokens) [rtweet]{.monospace} vignette.

[cc-by-sa-4]:                 http://creativecommons.org/licenses/by-sa/4.0/
[twitter-url]:                https://twitter.com
[r-fs-github]:                https://github.com/r-lib/fs
[r-rtweet-github]:            https://github.com/mkearney/rtweet
[dplyr-cheatsheet]:           https://github.com/rstudio/cheatsheets/raw/master/data-transformation.pdf
[r-devtools-github]:          https://github.com/r-lib/devtools
[gmu-rstudio-server]:         https://rstudio.cos.gmu.edu
[ggplot2-cheatsheet]:         https://www.rstudio.com/wp-content/uploads/2016/11/ggplot2-cheatsheet-2.1.pdf
[rstudio-cheatsheet]:         https://github.com/rstudio/cheatsheets/raw/master/rstudio-ide.pdf
[rmarkdown-reference]:        https://www.rstudio.com/wp-content/uploads/2015/03/rmarkdown-reference.pdf
[rmarkdown-cheatsheet]:       https://github.com/rstudio/cheatsheets/raw/master/rmarkdown-2.0.pdf
[data-import-cheatsheet]:     https://github.com/rstudio/cheatsheets/raw/master/data-import.pdf 
[twitter-developer-site]:     https://developer.twitter.com/en/apps
[css-gmu-twitter-account]:    https://twitter.com/CSS_GMU
[twitter-team-invite-issues]: https://twittercommunity.com/t/known-irregularity-some-developers-are-having-difficulties-inviting-team-members/126109
